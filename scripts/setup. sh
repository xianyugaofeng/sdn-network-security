#!/bin/bash

################################################################################
#                                                                              #
#  SDN Network Security System - Setup Script                                 #
#  用法: bash scripts/setup.sh                                                 #
#                                                                              #
#  修复: 正确处理虚拟环境路径问题                                                 #
#                                                                              #
################################################################################

set -e

# 获取脚本所在目录的绝对路径
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'  # No Color

# 打印函数
print_header() {
    echo -e "${BLUE}╔════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}���           SDN Network Security System Setup            ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

print_step() {
    echo -e "${GREEN}[✓]${NC} $1"
}

print_error() {
    echo -e "${RED}[✗]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[! ]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[i]${NC} $1"
}

# 清理函数
cleanup_on_error() {
    echo ""
    print_error "安装过程中出错,正在清理..."
    if [ -d "$PROJECT_DIR/venv" ]; then
        rm -rf "$PROJECT_DIR/venv"
        print_step "已删除不完整的虚拟环境"
    fi
    exit 1
}

# 设置错误捕获
trap cleanup_on_error ERR

# 检查Linux发行版
check_os() {
    print_info "检查操作系统..."

    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if [ -f /etc/os-release ]; then
            . /etc/os-release
            OS=$NAME
            print_step "操作系统:  $OS"
        else
            print_warning "无法识别发行版"
        fi
    else
        print_error "本脚本仅支持Linux系统"
        exit 1
    fi
}

# 检查依赖的系统命令
check_system_commands() {
    print_info "检查系统命令..."

    local commands=("python3" "pip3" "git")

    for cmd in "${commands[@]}"; do
        if command -v "$cmd" &> /dev/null; then
            local version=$($cmd --version 2>&1 | head -1)
            print_step "$cmd:  $version"
        else
            print_error "$cmd 未找到,请先安装"
            exit 1
        fi
    done
}

# 检查Python版本
check_python_version() {
    print_info "检查Python版本..."

    local python_version=$(python3 --version 2>&1 | awk '{print $2}')
    local major=$(echo $python_version | cut -d.  -f1)
    local minor=$(echo $python_version | cut -d. -f2)

    if [ "$major" -lt 3 ] || ([ "$major" -eq 3 ] && [ "$minor" -lt 6 ]); then
        print_error "需要Python 3.6以上版本 (当���:  $python_version)"
        exit 1
    fi

    print_step "Python版本: $python_version"
}

# 创建虚拟环境
setup_venv() {
    print_info "设置Python虚拟环境..."

    # 检查是否已存在虚拟环境
    if [ -d "$PROJECT_DIR/venv" ]; then
        print_warning "虚拟环境已存在,正在删除旧版本..."
        rm -rf "$PROJECT_DIR/venv"
        print_step "已删除旧虚拟环境"
    fi

    # 创建虚拟环境
    print_info "创建虚拟环境 ($PROJECT_DIR/venv)..."

    if python3 -m venv "$PROJECT_DIR/venv"; then
        print_step "虚拟环境创建成功"
    else
        print_error "虚拟环境创建失败"
        exit 1
    fi

    # 验证虚拟环境是否创建成功
    if [ !  -f "$PROJECT_DIR/venv/bin/activate" ]; then
        print_error "虚拟环境激活脚本不存在"
        exit 1
    fi

    print_step "虚拟环境验证成功"

    # 激活虚拟环境
    print_info "激活虚拟环境..."
    source "$PROJECT_DIR/venv/bin/activate"

    if [ -n "$VIRTUAL_ENV" ]; then
        print_step "虚拟环境已激活:  $VIRTUAL_ENV"
    else
        print_error "虚拟环境激活失败"
        exit 1
    fi
}

# 升级pip
upgrade_pip() {
    print_info "升级pip, setuptools和wheel..."

    python3 -m pip install --upgrade pip setuptools wheel > /dev/null 2>&1

    if [ $? -eq 0 ]; then
        print_step "pip, setuptools和wheel已升级"
    else
        print_error "pip升级失败"
        exit 1
    fi
}

# 安装Python依赖
install_dependencies() {
    print_info "安装Python依赖..."

    if [ !  -f "$PROJECT_DIR/requirements.txt" ]; then
        print_error "requirements.txt 未找到"
        exit 1
    fi

    # 显示当前进度
    echo "依赖包列表:"
    grep -E "^[a-zA-Z]" "$PROJECT_DIR/requirements. txt" | head -10
    echo "..."
    echo ""

    # 安装依赖
    if pip install -r "$PROJECT_DIR/requirements.txt" > /dev/null 2>&1; then
        print_step "Python依赖安装成功"
    else
        print_error "Python依赖安装失败,尝试详细模式..."
        pip install -r "$PROJECT_DIR/requirements.txt"
        exit 1
    fi
}

# 创建必要目录
create_directories() {
    print_info "创建必要目录..."

    local dirs=("logs" "data" "config" "docs" "tests" "scripts")

    for dir in "${dirs[@]}"; do
        local full_path="$PROJECT_DIR/$dir"
        if [ ! -d "$full_path" ]; then
            mkdir -p "$full_path"
            print_step "目录已创建: $dir"
        else
            print_warning "目录已存在:  $dir"
        fi
    done
}

# 初始化数据库
initialize_database() {
    print_info "初始化数据库..."

    # 验证当前Python环境
    if ! command -v python &> /dev/null; then
        print_error "Python未在PATH中,虚拟环境可能未正确激活"
        exit 1
    fi

    # 运行数据库初始化脚本
    python3 << 'EOF'
import sys
import os

# 添加项目目录到Python路径
sys.path.insert(0, os.getcwd())

try:
    from utils.db_helper import DatabaseHelper

    print("初始化数据库.. .", end=" ", flush=True)
    db = DatabaseHelper()
    db.connect()

    # 获取数据库信息
    info = db.get_database_info()
    db.disconnect()

    print(f"成功 (路径: {info. get('database_path', 'unknown')})")

except Exception as e:
    print(f"失败: {e}")
    sys.exit(1)
EOF

    if [ $? -eq 0 ]; then
        print_step "数据库初始化成功"
    else
        print_error "数据库初始化失败"
        exit 1
    fi
}

# 检查可选依赖
check_optional_dependencies() {
    print_info "检查可选依赖..."

    # 检查Ryu
    if python3 -c "import ryu" 2>/dev/null; then
        local ryu_version=$(python3 -c "import ryu; print(ryu.__version__)" 2>/dev/null)
        print_step "Ryu已安装 (版本: $ryu_version)"
    else
        print_warning "Ryu未安装 (需要Snort支持)"
    fi

    # 检查Mininet
    if command -v mn &> /dev/null; then
        print_step "Mininet已安装"
    else
        print_warning "Mininet未安装 (网络仿真需要)"
        echo "    安装命令:  sudo apt-get install mininet"
    fi

    # 检查Open vSwitch
    if command -v ovs-vsctl &> /dev/null; then
        print_step "Open vSwitch已安装"
    else
        print_warning "Open vSwitch未安装"
        echo "    安装命令: sudo apt-get install openvswitch-switch"
    fi
}

# 配置文件检查
check_config_files() {
    print_info "检查配置文件..."

    local config_files=("config/config.yaml" "config/rules.json")

    for file in "${config_files[@]}"; do
        if [ -f "$PROJECT_DIR/$file" ]; then
            print_step "配置文件存在: $file"
        else
            print_warning "配置文件缺失: $file"
        fi
    done
}

# 权限设置
setup_permissions() {
    print_info "设置文件权限..."

    if [ -d "$PROJECT_DIR/scripts" ]; then
        chmod +x "$PROJECT_DIR/scripts"/*. sh 2>/dev/null || true
        chmod +x "$PROJECT_DIR/scripts"/*.py 2>/dev/null || true
        print_step "脚本权限已配置"
    fi
}

# 生成快速开始指南
generate_quick_start() {
    print_info "生成快速开始指南..."
}